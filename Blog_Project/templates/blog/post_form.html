{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-md-9">
            <div class="card border-0 shadow-lg">
                <div class="card-body p-4">
                    <h2 class="mb-3 text-gradient fw-bold">{% if object %}Edit Post{% else %}Create New Post{% endif %}
                    </h2>

                    <form method="POST" enctype="multipart/form-data" id="postForm">
                        {% csrf_token %}

                        <!-- Form Fields (Compact) -->
                        {% for field in form %}
                        <div class="mb-2">
                            {% if not field.is_hidden %}
                            <label class="form-label fw-bold mb-1 small">{{ field.label }}</label>
                            {% endif %}

                            {{ field }}

                            {% if field.help_text %}
                            <small class="form-text text-muted d-block mt-1 small">{{ field.help_text }}</small>
                            {% endif %}

                            {% for error in field.errors %}
                            <div class="text-danger small mt-1"><i class="fas fa-exclamation-circle me-1"></i>{{ error
                                }}</div>
                            {% endfor %}
                        </div>
                        {% endfor %}

                        <div class="d-flex gap-2 mt-4 pt-3 border-top">
                            <button class="btn btn-primary rounded-pill px-4 py-2 fw-bold shadow-sm flex-grow-1 btn-sm"
                                type="button" onclick="submitForm('published')">
                                <i class="fas fa-paper-plane me-2"></i>Publish Post
                            </button>
                            <button class="btn btn-secondary rounded-pill px-3 py-2 fw-bold shadow-sm btn-sm"
                                type="button" onclick="submitForm('draft')">
                                <i class="fas fa-save me-2"></i>Save Draft
                            </button>
                            <a href="{% url 'home' %}"
                                class="btn btn-outline-danger rounded-pill px-3 py-2 fw-bold btn-sm">Cancel</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- TinyMCE Integration (Stable, Full Features) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/tinymce/6.8.2/tinymce.min.js" referrerpolicy="origin"></script>

<style>
    /* TinyMCE Customization for clean look */
    .tox-tinymce {
        border: 1px solid var(--border) !important;
        border-radius: 12px !important;
        /* Remove default shadow */
        box-shadow: none !important;
    }

    /* Remove 'Powered by Tiny' and other promotional elements */
    .tox-statusbar__branding,
    .tox-promotion {
        display: none !important;
    }

    /* Optional: Ensure toolbars blend if background desired is fully seamless */
    /* .tox-toolbar__primary { background: transparent !important; } */
</style>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Check strict theme from data-theme attribute or system preference
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark' ||
            (!document.documentElement.getAttribute('data-theme') && window.matchMedia('(prefers-color-scheme: dark)').matches);

        tinymce.init({
            selector: '#post-content',
            height: 500,
            menubar: true,

            // Branding Removals
            branding: false,
            promotion: false,

            plugins: [
                'advlist', 'autolink', 'lists', 'link', 'image', 'charmap', 'preview',
                'anchor', 'searchreplace', 'visualblocks', 'code', 'fullscreen',
                'insertdatetime', 'media', 'table', 'help', 'wordcount', 'emoticons'
            ],
            toolbar: 'undo redo | formatselect | ' +
                'fontfamily fontsize | bold italic underline strikethrough | ' +
                'forecolor backcolor | alignleft aligncenter ' +
                'alignright alignjustify | bullist numlist outdent indent | ' +
                'removeformat | help',

            // Strict Color Enforcement via content_style
            content_style: `
                body { 
                    font-family: 'Inter', sans-serif; 
                    font-size: 16px; 
                    background-color: #ffffff; /* Force white background for black text readability */
                    color: #000000 !important; /* Force black text as requested */
                }
                a { color: #4f46e5; }
            `,

            // Dark Mode Support
            skin: isDark ? 'oxide-dark' : 'oxide',
            content_css: isDark ? 'dark' : 'default',

            setup: function (editor) {
                editor.on('change', function () {
                    editor.save(); // Sync content to textarea automatically
                });
            }
        });
    });

    function submitForm(status) {
        // Update hidden status field
        let statusField = document.querySelector('input[name="status"]');
        if (!statusField) {
            let input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'status';
            input.id = 'id_status';
            input.value = status;
            document.getElementById('postForm').appendChild(input);
        } else {
            statusField.value = status;
        }

        // Trigger TinyMCE save to ensure textarea is populated
        if (tinymce.get('post-content')) {
            tinymce.get('post-content').save();
        }

        document.getElementById('postForm').submit();
    }
</script>
{% endblock %}