{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Article Header -->
            <div class="mb-4 text-center">
                <span class="badge bg-primary mb-2">{{ post.category.name }}</span>
                <h1 class="fw-bolder mb-1">{{ post.title }}</h1>
                <div class="text-muted fst-italic mb-2">
                    Posted on {{ post.created_at|date:"F d, Y" }} by {{
                    post.author.get_full_name|default:post.author.username }}
                </div>
                <!-- Tags -->
                <div>
                    {% for tag in post.tags.all %}
                    <span class="badge bg-secondary text-decoration-none link-light">{{ tag.name }}</span>
                    {% endfor %}
                </div>
            </div>

            <!-- Preview Image -->
            {% if post.featured_image %}
            <figure class="mb-4">
                <img class="img-fluid rounded shadow-sm" src="{{ post.featured_image.url }}" alt="..."
                    style="width:100%; max-height:500px; object-fit:cover;">
            </figure>
            {% endif %}

            <!-- Post Content -->
            <section class="mb-5 post-content fs-5" style="line-height: 1.8;">
                {{ post.content|safe|linebreaks }}
            </section>

            <!-- Interaction Section -->
            <div class="d-flex align-items-center justify-content-between p-3 border rounded mb-5 bg-card">
                <div class="d-flex gap-3">
                    <!-- Like Form -->
                    <form action="{% url 'post_interaction' post.slug %}" method="POST" class="d-inline">
                        {% csrf_token %}
                        <input type="hidden" name="interaction_type" value="like">
                        <button type="submit"
                            class="btn {% if user_interaction == 'like' %}btn-primary{% else %}btn-outline-primary{% endif %} position-relative">
                            <i class="fas fa-thumbs-up me-1"></i> {{ likes_count }}
                        </button>
                    </form>
                    <!-- Dislike Form -->
                    <form action="{% url 'post_interaction' post.slug %}" method="POST" class="d-inline">
                        {% csrf_token %}
                        <input type="hidden" name="interaction_type" value="dislike">
                        <button type="submit"
                            class="btn {% if user_interaction == 'dislike' %}btn-danger{% else %}btn-outline-danger{% endif %}">
                            <i class="fas fa-thumbs-down me-1"></i> {{ dislikes_count }}
                        </button>
                    </form>
                </div>
                <div class="text-muted">
                    <i class="fas fa-eye me-1"></i> {{ post.views_count }} Views
                </div>
            </div>

            <!-- Comments Section -->
            <section class="mb-5">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <h4 class="mb-4">Comments ({{ comments.count }})</h4>

                        <!-- Comment Form -->
                        {% if user.is_authenticated %}
                        <form class="mb-5" action="{% url 'add_comment' post.slug %}" method="POST">
                            {% csrf_token %}
                            <div class="mb-3">
                                {{ comment_form.content }}
                            </div>
                            <div class="d-flex justify-content-end">
                                <button type="submit" class="btn btn-primary px-4 rounded-pill">Post Comment</button>
                            </div>
                        </form>
                        {% else %}
                        <div class="alert alert-info mb-4">Please <a href="{% url 'account_login' %}"
                                class="alert-link">login</a> to join the conversation.</div>
                        {% endif %}

                        <!-- Comments List -->
                        {% for comment in comments %}
                        <div class="d-flex mb-4 p-3 rounded" style="background-color: var(--background);">
                            <div class="flex-shrink-0">
                                {% if comment.user.profile.profile_picture %}
                                <img class="rounded-circle" src="{{ comment.user.profile.profile_picture.url }}"
                                    alt="..." width="50" height="50" style="object-fit:cover;">
                                {% else %}
                                <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center text-white"
                                    style="width: 50px; height: 50px;">
                                    {{ comment.user.username|first|upper }}
                                </div>
                                {% endif %}
                            </div>
                            <div class="ms-3 w-100">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="fw-bold mb-0">{{ comment.user.username }}</h6>
                                    <small class="text-muted">{{ comment.created_at|timesince }} ago</small>
                                </div>
                                <p class="mb-1">{{ comment.content }}</p>
                            </div>
                        </div>
                        {% empty %}
                        <p class="text-muted text-center py-4">No comments yet. Be the first to share your thoughts!</p>
                        {% endfor %}
                    </div>
                </div>
            </section>
        </div>
    </div>
</div>
{% endblock %}