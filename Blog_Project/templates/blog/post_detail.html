{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid px-4 px-lg-5 my-4 animate-load">
    <div class="row justify-content-center">
        <!-- Main Content (Centered, slightly constrained for readability but wider than before) -->
        <div class="col-lg-10">
            <div class="card border-0 shadow-lg overflow-hidden">
                <!-- Post Image -->
                <!-- Post Image -->
                {% if post.featured_image %}
                <div class="position-relative" style="height: 350px;">
                    <img src="{{ post.featured_image.url }}" class="w-100 h-100 object-fit-cover"
                        alt="{{ post.title }}">
                    <div class="position-absolute bottom-0 start-0 w-100 p-4"
                        style="background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);">
                        <span class="badge bg-primary mb-2 shadow-sm">{{ post.category.name }}</span>
                        <h1 class="fw-bold text-white mb-2 fs-2 text-shadow">{{ post.title }}</h1>
                        <div class="d-flex align-items-center text-white small">
                            <div class="d-flex align-items-center me-3">
                                {% if post.author.profile.profile_picture %}
                                <img src="{{ post.author.profile.profile_picture.url }}"
                                    class="rounded-circle me-2 border border-2 border-white"
                                    style="width: 30px; height: 30px; object-fit: cover;">
                                {% else %}
                                <div class="rounded-circle bg-secondary me-2 d-flex align-items-center justify-content-center text-white border border-2 border-white"
                                    style="width: 30px; height: 30px;">
                                    {{ post.author.username|make_list|first|upper }}
                                </div>
                                {% endif %}
                                <span class="fw-bold text-white">{{ post.author.username }}</span>
                            </div>
                            <span class="me-3">
                                <i class="far fa-calendar-alt me-2"></i>
                                {{ post.created_at|date:"F d, Y" }}
                            </span>
                            <span><i class="fas fa-eye me-2"></i>{{ post.views_count }} views</span>
                        </div>
                    </div>
                </div>
                {% endif %}

                <div class="card-body p-3 p-md-4">
                    <!-- Post Controls (Edit/Delete for Author/Admin) -->
                    {% if user.is_staff and user == post.author or user.is_superuser %}
                    <div class="mb-3 d-flex justify-content-end gap-2">
                        <a href="{% url 'post_update' post.slug %}"
                            class="btn btn-outline-warning btn-sm rounded-pill px-3 fw-bold"><i
                                class="fas fa-edit me-1"></i>Edit</a>
                        <a href="{% url 'post_delete' post.slug %}"
                            class="btn btn-outline-danger btn-sm rounded-pill px-3 fw-bold"><i
                                class="fas fa-trash me-1"></i>Delete</a>
                    </div>
                    {% endif %}

                    <!-- Content -->
                    <div class="article-content mb-4 text-break" style="font-size: 1rem; line-height: 1.6;">
                        {{ post.content|safe }}
                    </div>

                    <!-- Tags -->
                    {% if post.tags.all %}
                    <div class="mb-3">
                        {% for tag in post.tags.all %}
                        <span class="badge bg-secondary border me-1 rounded-pill px-2 py-1 fw-normal"
                            style="font-size: 0.75rem;">#{{ tag.name }}</span>
                        {% endfor %}
                    </div>
                    {% endif %}

                    <hr class="my-3 opacity-25">

                    <!-- Interaction Section -->
                    <div class="d-flex align-items-center justify-content-start mb-4 flex-wrap gap-2">
                        <!-- Like Button -->
                        <button onclick="toggleInteraction('{{ post.slug }}', 'like')" id="like-btn"
                            class="btn btn-outline-primary rounded-pill px-3 py-1 fw-bold d-flex align-items-center gap-1 btn-sm {% if user_interaction == 'like' %}active{% endif %}">
                            <i class="fas fa-thumbs-up"></i> <span>Like</span>
                            <span class="badge bg-primary text-white ms-1 rounded-pill" id="likes-count">
                                {{ likes_count }}
                            </span>
                        </button>

                        <!-- Dislike Button -->
                        <button onclick="toggleInteraction('{{ post.slug }}', 'dislike')" id="dislike-btn"
                            class="btn btn-outline-danger rounded-pill px-3 py-1 fw-bold d-flex align-items-center gap-1 btn-sm {% if user_interaction == 'dislike' %}active{% endif %}">
                            <i class="fas fa-thumbs-down"></i> <span>Dislike</span>
                        </button>

                        <!-- Share -->
                        <div class="dropdown">
                            <button
                                class="btn btn-light rounded-pill px-3 py-1 fw-bold shadow-sm dropdown-toggle btn-sm"
                                type="button" data-bs-toggle="dropdown">
                                <i class="fas fa-share-alt me-1"></i>Share
                            </button>
                            <ul class="dropdown-menu border-0 shadow">
                                <li><a class="dropdown-item"
                                        href="https://wa.me/?text={{ request.build_absolute_uri|urlencode }}"
                                        target="_blank"><i class="fab fa-whatsapp me-2 text-success"></i>WhatsApp</a>
                                </li>
                                <li><a class="dropdown-item"
                                        href="https://t.me/share/url?url={{ request.build_absolute_uri|urlencode }}&text={{ post.title|urlencode }}"
                                        target="_blank"><i class="fab fa-telegram me-2 text-info"></i>Telegram</a></li>
                                <li><a class="dropdown-item"
                                        href="https://www.linkedin.com/sharing/share-offsite/?url={{ request.build_absolute_uri|urlencode }}"
                                        target="_blank"><i class="fab fa-linkedin me-2 text-primary"></i>LinkedIn</a>
                                </li>
                                <li><a class="dropdown-item"
                                        href="https://www.facebook.com/sharer/sharer.php?u={{ request.build_absolute_uri|urlencode }}"
                                        target="_blank"><i class="fab fa-facebook me-2 text-primary"></i>Facebook</a>
                                </li>
                                <li><a class="dropdown-item"
                                        href="https://twitter.com/intent/tweet?url={{ request.build_absolute_uri|urlencode }}&text={{ post.title|urlencode }}"
                                        target="_blank"><i class="fab fa-x-twitter me-2"></i>X</a></li>
                                <li><a class="dropdown-item" href="https://www.instagram.com/" target="_blank"><i
                                            class="fab fa-instagram me-2 text-danger"></i>Instagram</a></li>
                                <li>
                                    <hr class="dropdown-divider">
                                </li>
                                <li><a class="dropdown-item" href="javascript:void(0)" onclick="copyToClipboard()"><i
                                            class="fas fa-link me-2"></i>Copy Link</a></li>
                            </ul>
                        </div>
                    </div>

                    <!-- Comments Card -->
                    <div class="bg-light p-3 rounded-4 mb-3 dark-mode-adjust">
                        <h4 class="fw-bold mb-3 gradient-text fs-5"><i class="fas fa-comments me-2"></i>Discussion
                            (<span id="comment-count">{{ comments.count }}</span>)</h4>

                        {% if user.is_authenticated %}
                        <form onsubmit="submitComment(event, '{{ post.slug }}')" class="mb-3 position-relative"
                            id="add-comment-form">
                            {% csrf_token %}
                            <div class="mb-2">
                                <label for="commentContent" class="form-label fw-bold small text-muted mb-1"
                                    style="font-size: 1rem;">Join the discussion</label>
                                <textarea class="form-control rounded-3 border-0 shadow-sm py-2 px-3"
                                    placeholder="Leave a comment here..." id="commentContent" name="content" rows="2"
                                    style="min-height: 60px; font-size: 0.9rem;" required></textarea>
                            </div>
                            <div class="d-flex justify-content-end">
                                <button type="submit"
                                    class="btn btn-primary rounded-pill px-3 py-1 fw-bold shadow-sm btn-sm">Comment</button>
                            </div>
                        </form>
                        {% else %}
                        <div
                            class="alert alert-primary border-0 mb-3 rounded-3 shadow-sm d-flex align-items-center p-3">
                            <i class="fas fa-info-circle me-3 fa-lg"></i>
                            <div>
                                <h6 class="fw-bold mb-1">Join the conversation</h6>
                                <p class="mb-0 small">Please <a href="{% url 'account_login' %}"
                                        class="fw-bold text-decoration-underline">sign in</a> to leave a comment.</p>
                            </div>
                        </div>
                        {% endif %}

                        <div class="comment-list" id="comment-list">
                            {% for comment in comments %}
                            <div class="d-flex mb-2 animate-hover p-2 rounded-3 bg-white shadow-sm border comment-card"
                                id="comment-{{ comment.pk }}">
                                <div class="flex-shrink-0">
                                    {% if comment.user.profile.profile_picture %}
                                    <img src="{{ comment.user.profile.profile_picture.url }}"
                                        class="rounded-circle object-fit-cover" width="40" height="40">
                                    {% else %}
                                    <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center text-white fw-bold"
                                        style="width: 40px; height: 40px; font-size: 0.8rem;">
                                        {{ comment.user.username|make_list|first|upper }}
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="flex-grow-1 ms-2 w-100">
                                    <div class="d-flex justify-content-between align-items-start mb-0">
                                        <div class="d-flex flex-column w-100">
                                            <div class="d-flex align-items-center gap-2">
                                                <h6 class="fw-bold mb-0" style="font-size: 0.9rem;">
                                                    {{ comment.user.username }}
                                                </h6>
                                                <small class="text-muted" style="font-size: 0.7rem;">
                                                    {{ comment.created_at|timesince }} ago
                                                </small>
                                            </div>
                                            <div id="comment-content-wrapper-{{ comment.pk }}">
                                                <p class="mb-0 text-muted mt-1" id="comment-content-{{ comment.pk }}"
                                                    style="font-size: 0.9rem; line-height: 1.3;">{{ comment.content }}
                                                </p>
                                            </div>
                                        </div>

                                        <!-- Three-Dot Menu -->
                                        {% if user.is_superuser or user == post.author or user == comment.user %}
                                        <div class="dropdown ms-2">
                                            <button class="btn btn-link text-muted p-0 border-0" type="button"
                                                data-bs-toggle="dropdown" aria-expanded="false">
                                                <i class="fas fa-ellipsis-v"></i>
                                            </button>
                                            <ul class="dropdown-menu dropdown-menu-end border-0 shadow-sm">
                                                <li><a class="dropdown-item small" href="javascript:void(0)"
                                                        onclick="enableEdit({{ comment.pk }})"><i
                                                            class="fas fa-edit me-2"></i>Edit</a></li>
                                                <li><a class="dropdown-item small text-danger" href="javascript:void(0)"
                                                        onclick="deleteComment({{ comment.pk }})"><i
                                                            class="fas fa-trash me-2"></i>Delete</a></li>
                                            </ul>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% empty %}
                            <div class="text-center py-4 opacity-50" id="no-comments-msg">
                                <i class="far fa-comments fa-2x mb-2"></i>
                                <p class="fw-bold small">No comments yet. Be the first!</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Specific overrides for this page */
    .text-shadow {
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
    }

    [data-theme="dark"] .bg-light {
        background-color: #1e293b !important;
        /* Matches card bg in dark mode */
    }

    [data-theme="dark"] .comment-card {
        background-color: #0f172a !important;
        /* Darker than container */
        border-color: #334155 !important;
    }

    [data-theme="dark"] .comment-card .text-muted {
        color: #cbd5e1 !important;
    }
</style>

<script>
    function copyToClipboard() {
        navigator.clipboard.writeText(window.location.href).then(() => {
            alert("Link copied to clipboard!");
        }).catch(err => {
            console.error('Failed to copy: ', err);
        });
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    async function toggleInteraction(slug, type) {
        const csrftoken = getCookie('csrftoken');
        try {
            const response = await fetch(`/post/${slug}/like/`, { // View handles both like/dislike path, actually mapped to post_interaction logic
                // Wait, view mapping: path('post/<slug:slug>/like/', views.post_interaction ...) 
                // The URL is .../like/ but the view handles 'like' AND 'dislike' types? 
                // Yes, I see interaction_type in body.
                // But wait, the URL in urls.py is just 'post_interaction'. 
                // Let's use the named URL logic if possible, or hardcode based on slug.
                // The path is 'post/<slug>/like/'.
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ 'interaction_type': type })
            });
            const data = await response.json();
            if (response.ok) {
                document.getElementById('likes-count').innerText = data.likes_count;
                const dlCount = document.getElementById('dislikes-count');
                if (dlCount) dlCount.innerText = data.dislikes_count;

                // Update active classes
                const likeBtn = document.getElementById('like-btn');
                const dislikeBtn = document.getElementById('dislike-btn');

                likeBtn.classList.remove('active');
                dislikeBtn.classList.remove('active');

                if (data.user_interaction === 'like') likeBtn.classList.add('active');
                if (data.user_interaction === 'dislike') dislikeBtn.classList.add('active');
            }
        } catch (error) { console.error('Error:', error); }
    }

    async function submitComment(event, slug) {
        event.preventDefault();
        const content = document.getElementById('commentContent').value;
        const csrftoken = getCookie('csrftoken');

        try {
            const response = await fetch(`/post/${slug}/comment/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded', // Standard form data for backend compatibility unless I changed to JSON
                    // Wait, my backend 'add_comment' uses CommentForm(request.POST). It expects form-data.
                    'X-CSRFToken': csrftoken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: new URLSearchParams({ 'content': content })
            });

            const data = await response.json();
            if (response.ok) {
                document.getElementById('commentContent').value = '';
                document.getElementById('comment-count').innerText = data.count;

                const noCommentsMsg = document.getElementById('no-comments-msg');
                if (noCommentsMsg) noCommentsMsg.remove();

                // Prepend new comment
                const commentList = document.getElementById('comment-list');
                const newCommentHtml = `
                    <div class="d-flex mb-2 animate-hover p-2 rounded-3 bg-white shadow-sm border comment-card" id="comment-${data.comment.id}">
                        <div class="flex-shrink-0">
                            ${data.comment.profile_picture_url ?
                        `<img src="${data.comment.profile_picture_url}" class="rounded-circle object-fit-cover" width="40" height="40">` :
                        `<div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center text-white fw-bold" style="width: 40px; height: 40px; font-size: 0.8rem;">${data.comment.initial}</div>`
                    }
                        </div>
                        <div class="flex-grow-1 ms-2 w-100">
                            <div class="d-flex justify-content-between align-items-start mb-0">
                                <div class="d-flex flex-column w-100">
                                    <div class="d-flex align-items-center gap-2">
                                        <h6 class="fw-bold mb-0" style="font-size: 0.9rem;">${data.comment.user}</h6>
                                        <small class="text-muted" style="font-size: 0.7rem;">${data.comment.created_at}</small>
                                    </div>
                                    <div id="comment-content-wrapper-${data.comment.id}">
                                        <p class="mb-0 text-muted mt-1" id="comment-content-${data.comment.id}" style="font-size: 0.9rem; line-height: 1.3;">${data.comment.content}</p>
                                    </div>
                                </div>
                                <div class="dropdown ms-2">
                                    <button class="btn btn-link text-muted p-0 border-0" type="button" data-bs-toggle="dropdown"><i class="fas fa-ellipsis-v"></i></button>
                                    <ul class="dropdown-menu dropdown-menu-end border-0 shadow-sm">
                                        <li><a class="dropdown-item small" href="javascript:void(0)" onclick="enableEdit(${data.comment.id})"><i class="fas fa-edit me-2"></i>Edit</a></li>
                                        <li><a class="dropdown-item small text-danger" href="javascript:void(0)" onclick="deleteComment(${data.comment.id})"><i class="fas fa-trash me-2"></i>Delete</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                commentList.insertAdjacentHTML('afterbegin', newCommentHtml);
            }
        } catch (error) { console.error('Error:', error); }
    }

    let originalContentStore = {};

    function enableEdit(id) {
        const wrapper = document.getElementById(`comment-content-wrapper-${id}`);
        const p = document.getElementById(`comment-content-${id}`);
        const text = p.innerText;
        originalContentStore[id] = text;

        wrapper.innerHTML = `
            <textarea class="form-control mb-2 rounded-3" id="edit-input-${id}" rows="2">${text}</textarea>
            <div class="d-flex justify-content-end gap-2">
                <button class="btn btn-sm btn-light rounded-pill px-3" onclick="cancelEdit(${id})">Cancel</button>
                <button class="btn btn-sm btn-primary rounded-pill px-3" onclick="saveEdit(${id})">Save</button>
            </div>
        `;
    }

    function cancelEdit(id) {
        const wrapper = document.getElementById(`comment-content-wrapper-${id}`);
        wrapper.innerHTML = `<p class="mb-0 text-muted mt-1" id="comment-content-${id}" style="font-size: 0.9rem; line-height: 1.3;">${originalContentStore[id]}</p>`;
    }

    async function saveEdit(id) {
        const content = document.getElementById(`edit-input-${id}`).value;
        const csrftoken = getCookie('csrftoken');
        try {
            const response = await fetch(`/comment/${id}/edit/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ 'content': content })
            });
            const data = await response.json();
            if (response.ok) {
                const wrapper = document.getElementById(`comment-content-wrapper-${id}`);
                wrapper.innerHTML = `<p class="mb-0 text-muted mt-1" id="comment-content-${id}" style="font-size: 0.9rem; line-height: 1.3;">${data.content}</p>`;
            }
        } catch (error) { console.error('Error:', error); }
    }

    async function deleteComment(id) {
        if (!confirm("Are you sure you want to delete this comment?")) return;
        const csrftoken = getCookie('csrftoken');
        try {
            const response = await fetch(`/comment/${id}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            const data = await response.json();
            if (response.ok) {
                document.getElementById(`comment-${id}`).remove();
                document.getElementById('comment-count').innerText = data.count;
            }
        } catch (error) { console.error('Error:', error); }
    }
</script>
{% endblock %}