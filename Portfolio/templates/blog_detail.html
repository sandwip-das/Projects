{% extends 'base.html' %}
{% load static core_tags humanize %}

{% block title %}Blog Content{% endblock %}

{% block content %}
<div class="pt-[80px] min-h-screen relative bg-gradient-to-br from-[#7bed9f] via-[#12CBC4] to-[#ffeaa7]">

    {% if not user.is_authenticated %}
    <!-- Blur Overlay for unauthenticated users -->
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-[#0a0a0f]/80 backdrop-blur-xl">
        <div
            class="bg-[#c7ecee] p-8 md:p-12 rounded-2xl shadow-[0_0_50px_rgba(46,204,113,0.15)] border border-white/10 text-center max-w-lg mx-4 transform hover:scale-[1.02] transition-transform duration-300">
            <i class="fas fa-lock text-6xl text-[#2ecc71] mb-6 block animate-pulse"></i>
            <h2 class="text-3xl font-bold text-black mb-3">Premium Content</h2>
            <p class="text-black mb-8 text-lg">This full article requires an account. Please sign in or register to
                join our learning community.</p>
            <div class="flex flex-col gap-4">
                <a href="{% url 'account_login' %}?next={{ request.path }}"
                    class="px-8 py-4 bg-gradient-to-r from-[#2ecc71] to-[#27ae60] text-black font-bold rounded-xl hover:shadow-[0_0_20px_rgba(46,204,113,0.4)] transition-all">Sign
                    In</a>
                <a href="{% url 'account_signup' %}?next={{ request.path }}"
                    class="px-8 py-4 bg-black/5 border border-black/10 text-black font-bold rounded-xl hover:bg-black/10 transition-all">Create
                    Account</a>
                <a href="{% url 'home' %}#blog"
                    class="mt-4 text-sm text-black hover:text-[#00a8ff] transition-colors underline decoration-black/30 underline-offset-4">Return
                    to Main Page</a>
            </div>
        </div>
    </div>
    {% endif %}

    <div
        class="w-full max-w-[1400px] mx-auto px-8 sm:px-12 lg:px-20 2xl:px-32 pb-8 pt-0 text-black {% if not user.is_authenticated %}blur-[12px] select-none pointer-events-none opacity-50 overflow-hidden h-screen{% endif %}">

        <div class="glass-card p-8 md:p-16 relative overflow-hidden">
            <!-- decorative gradient -->
            <div
                class="absolute top-0 right-0 w-[300px] h-[300px] bg-[#2ecc71]/10 rounded-full blur-[100px] pointer-events-none">
            </div>

            <div class="mb-8 text-center pt-2">
                <h1
                    class="text-xl sm:text-2xl md:text-3xl lg:text-4xl 2xl:text-5xl font-extrabold text-black mt-2 mb-4 py-2 leading-snug transition-all duration-300">
                    {{ post.title }}</h1>
                <div
                    class="flex flex-wrap items-center justify-center gap-4 sm:gap-6 text-xs sm:text-sm text-[#5D2E8C]">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-tag"></i>
                        <span
                            class="px-3 py-1 rounded-full bg-[#5D2E8C]/5 font-bold border border-[#5D2E8C]/10 tracking-wider uppercase text-[10px] sm:text-xs">
                            {{ post.category }}
                        </span>
                    </div>

                    <div class="flex items-center gap-2 font-semibold">
                        <i class="fas fa-user-circle"></i>
                        <span>Sandwip</span>
                    </div>

                    <div class="flex items-center gap-2 font-medium">
                        <i class="fas fa-calendar-alt"></i>
                        <span class="opacity-90">{{ post.created_at|date:"M d, Y h:i A" }}</span>
                    </div>
                </div>
            </div>

            <!-- Pre-Content / Top Images -->
            {% if post.images.exists %}
            {% if post.images.count == 1 %}
            {% with img=post.images.first %}
            <div class="flex justify-center mb-10">
                <div class="rounded-xl overflow-hidden border border-black/10 shadow-2xl w-full md:w-1/4">
                    <img src="{{ img.image.url }}" alt="{{ img.caption|default:post.title }}"
                        class="w-full h-auto object-cover max-h-[300px]">
                    {% if img.caption %}
                    <div class="bg-black/50 p-2 text-center text-xs text-gray-100 border-t border-black/10">
                        {{ img.caption }}
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endwith %}
            {% elif post.images.count >= 2 %}
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 justify-center mb-10">
                {% with img1=post.images.all.0 img2=post.images.all.1 %}
                <div class="md:col-start-2 rounded-xl overflow-hidden border border-black/10 shadow-2xl">
                    <img src="{{ img1.image.url }}" alt="{{ img1.caption|default:post.title }}"
                        class="w-full h-full object-cover aspect-video hover:scale-105 transition-transform duration-500">
                    {% if img1.caption %}
                    <div class="bg-black/50 p-1.5 text-center text-[10px] text-gray-100 absolute bottom-0 w-full">
                        {{ img1.caption }}
                    </div>
                    {% endif %}
                </div>
                <div class="rounded-xl overflow-hidden border border-black/10 shadow-2xl">
                    <img src="{{ img2.image.url }}" alt="{{ img2.caption|default:post.title }}"
                        class="w-full h-full object-cover aspect-video hover:scale-105 transition-transform duration-500">
                    {% if img2.caption %}
                    <div class="bg-black/50 p-1.5 text-center text-[10px] text-gray-100 absolute bottom-0 w-full">
                        {{ img2.caption }}
                    </div>
                    {% endif %}
                </div>
                {% endwith %}
            </div>
            {% endif %}
            {% endif %}

            <!-- Interspersed Content & Remaining Images -->
            <div
                class="prose prose-sm sm:prose-base md:prose-lg lg:prose-xl 2xl:prose-2xl max-w-none !text-black content-renderer leading-relaxed transition-all duration-300">
                {% if post.images.count > 2 %}
                {{ post|render_interleaved_content }}
                {% else %}
                {{ post.content|safe }}
                {% endif %}
            </div>

            <!-- Footer Metrics & Engagement Buttons -->
            <div
                class="mt-6 md:mt-8 pt-4 lg:pt-6 flex flex-col sm:flex-row flex-wrap items-center justify-between gap-4 sm:gap-6 border-t border-black/5">

                <!-- Metrics (View, Like, Dislike, Comment) as modern transparent buttons -->
                <div class="flex flex-wrap items-center justify-center gap-4 w-full md:w-auto h-full">
                    <div class="flex items-center gap-2 text-black group cursor-default">
                        <i class="fas fa-eye text-[#003B8E] group-hover:text-[#00a8ff] transition-transform"></i>
                        <span class="font-bold text-sm">{{ post.view_count }} Viewed</span>
                    </div>

                    <div class="flex items-center bg-black/5 rounded-full border border-black/10 overflow-hidden">
                        <form action="{% url 'toggle_reaction' post.id %}" method="POST" class="m-0 post-reaction-form">
                            {% csrf_token %}
                            <input type="hidden" name="reaction" value="like">
                            <button type="submit"
                                class="px-3 py-1.5 hover:bg-[#00a8ff]/20 text-black flex items-center gap-2 transition-all group">
                                <i class="fas fa-thumbs-up text-[#003B8E] group-hover:scale-110"></i>
                                <span class="text-xs font-bold" id="post-like-count">{{ post.like_count }}</span>
                            </button>
                        </form>
                        <div class="w-[1px] h-4 bg-black/20"></div>
                        <form action="{% url 'toggle_reaction' post.id %}" method="POST" class="m-0 post-reaction-form">
                            {% csrf_token %}
                            <input type="hidden" name="reaction" value="dislike">
                            <button type="submit"
                                class="px-3 py-1.5 hover:bg-[#00a8ff]/20 text-black flex items-center gap-2 transition-all group">
                                <i class="fas fa-thumbs-down text-[#ff4242] group-hover:scale-110"></i>
                                <span class="text-xs font-bold" id="post-dislike-count">{{ post.dislike_count }}</span>
                            </button>
                        </form>
                    </div>

                </div>

                <!-- Share / Back -->
                <div class="flex items-center gap-3 relative h-full">
                    <a href="{% url 'home' %}#blog"
                        class="px-4 py-2 rounded-full border border-black/20 bg-transparent text-black text-sm font-medium hover:border-[#00a8ff] hover:text-[#00a8ff] transition-all duration-300 flex items-center gap-2 shadow-sm hover:shadow-[0_0_15px_rgba(0,168,255,0.4)] group">
                        <i class="fas fa-arrow-left group-hover:-translate-x-1 transition-transform"></i> Home
                    </a>

                    <!-- Share Button & Menu Modal -->
                    <div class="relative">
                        <button onclick="toggleShareMenu(event)"
                            class="px-4 py-2 rounded-full border border-black/20 bg-transparent text-black text-sm font-medium hover:border-[#00a8ff] hover:text-[#00a8ff] transition-all duration-300 flex items-center gap-2 shadow-sm hover:shadow-[0_0_15px_rgba(0,168,255,0.4)] group">
                            <i class="fas fa-share-alt group-hover:-translate-y-1 transition-transform"></i>
                            <span>Share</span>
                        </button>

                        <div id="shareMenu"
                            class="absolute bottom-full right-0 mb-3 w-72 bg-[#1e1e2d] border border-white/10 rounded-2xl shadow-2xl p-5 hidden transform transition-all z-50 origin-bottom-right">
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="text-black font-bold text-sm">Share this post</h4>
                                <button onclick="toggleShareMenu()"
                                    class="text-gray-600 hover:text-black transition-colors">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>

                            <!-- Social Options -->
                            <div class="grid grid-cols-4 gap-3 mb-5">
                                <a href="javascript:void(0)" onclick="shareTo('facebook')"
                                    class="w-12 h-12 rounded-full bg-[#1877f2]/10 text-[#1877f2] flex items-center justify-center hover:bg-[#1877f2] hover:text-white transition-all hover:scale-110 mx-auto">
                                    <i class="fab fa-facebook-f text-lg"></i>
                                </a>
                                <a href="javascript:void(0)" onclick="shareTo('twitter')"
                                    class="w-12 h-12 rounded-full bg-[#1da1f2]/10 text-[#1da1f2] flex items-center justify-center hover:bg-[#1da1f2] hover:text-white transition-all hover:scale-110 mx-auto">
                                    <i class="fab fa-twitter text-lg"></i>
                                </a>
                                <a href="javascript:void(0)" onclick="shareTo('linkedin')"
                                    class="w-12 h-12 rounded-full bg-[#0a66c2]/10 text-[#0a66c2] flex items-center justify-center hover:bg-[#0a66c2] hover:text-white transition-all hover:scale-110 mx-auto">
                                    <i class="fab fa-linkedin-in text-lg"></i>
                                </a>
                                <a href="javascript:void(0)" onclick="shareTo('whatsapp')"
                                    class="w-12 h-12 rounded-full bg-[#25d366]/10 text-[#25d366] flex items-center justify-center hover:bg-[#25d366] hover:text-white transition-all hover:scale-110 mx-auto">
                                    <i class="fab fa-whatsapp text-xl"></i>
                                </a>
                            </div>

                            <!-- Copy Link -->
                            <div class="relative">
                                <label class="block text-xs text-black mb-1">Page Link</label>
                                <div
                                    class="flex border border-black/20 rounded-xl overflow-hidden bg-black/5 w-full focus-within:border-[#2ecc71] transition-colors">
                                    <input type="text" id="shareUrlInput" value="" readonly
                                        class="bg-transparent text-black text-xs px-3 py-3 w-full outline-none truncate">
                                    <button onclick="copyShareLink()"
                                        class="px-4 bg-[#2ecc71]/10 hover:bg-[#2ecc71]/20 transition-colors text-[#2ecc71] text-xs border-l border-black/20 font-bold flex-shrink-0 flex items-center gap-1">
                                        <i class="fas fa-copy"></i> Copy
                                    </button>
                                </div>
                                <div id="copySuccessMsg"
                                    class="absolute -top-10 right-0 bg-green-400 text-black text-xs px-3 py-1.5 rounded-lg shadow-lg opacity-0 transition-opacity flex items-center gap-1 pointer-events-none">
                                    <i class="fas fa-check-circle"></i> URL Copied!
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Comments Section -->
            <div id="comments" class="mt-8 sm:mt-12 lg:mt-16 pt-0 max-w-4xl mx-auto">
                <h3
                    class="text-lg sm:text-xl lg:text-2xl font-bold text-black mb-4 sm:mb-6 flex items-center gap-2 sm:gap-3 transition-all duration-300">
                    <i class="fas fa-comments text-[#ff5722] text-base lg:text-lg"></i>
                    <!-- prettier-ignore -->
                    Comments <span id="header-comment-count" class="bg-black/10 px-2 py-0.5 rounded-lg text-sm">
                        {{ post.comment_count }}
                    </span>
                </h3>

                <form action="{% url 'add_comment' post.id %}" method="POST" class="mb-8 block" id="main-comment-form">
                    {% csrf_token %}
                    <div
                        class="flex items-center gap-3 bg-black/5 p-2 px-4 rounded-full border border-black/10 transition-all">
                        <textarea name="content" rows="1"
                            oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px';"
                            class="w-full bg-transparent text-black border-none focus:border-none focus:ring-0 focus:outline-none p-1 text-sm resize-none placeholder-black/60 overflow-hidden min-h-0"
                            placeholder="Join the discussion..."></textarea>
                        <button type="submit"
                            class="p-2 text-black hover:text-[#00a8ff] transition-all hover:scale-110 flex items-center justify-center">
                            <svg viewBox="0 0 24 24" class="w-6 h-6 transform rotate-[45deg]" fill="none"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M22 2L11 13M22 2L15 22L11 13L2 9L22 2z"></path>
                            </svg>
                        </button>
                    </div>
                </form>

                <div class="space-y-4 pb-24">
                    {% for comment in post.comments.all|dictsortreversed:"created_at" %}
                    {% if not comment.parent %}
                    <div class="space-y-3">
                        <div
                            class="bg-transparent p-3 rounded-xl border border-black/5 flex gap-3 hover:bg-black/5 transition-colors">

                            {% with p_pic=comment.user.profile.profile_picture.name %}
                            {% if p_pic and "default" not in p_pic %}
                            <img src="{{ comment.user.profile.profile_picture.url }}" alt="{{ comment.user.username }}"
                                class="w-10 h-10 rounded-full object-cover flex-shrink-0 border border-black/10">
                            {% else %}
                            <div
                                class="w-10 h-10 rounded-full bg-gradient-to-br from-[#2ecc71] to-blue-500 flex items-center justify-center flex-shrink-0 text-black font-bold text-lg">
                                {{ comment.user.username|make_list|first|upper }}
                            </div>
                            {% endif %}
                            {% endwith %}

                            <div class="flex-1">
                                <div class="flex items-baseline justify-between mb-1">
                                    <div class="flex items-baseline gap-2">
                                        <h4 class="font-bold text-sm">{{ comment.user.username }}</h4>
                                        <span class="text-xs opacity-60">
                                            {{ comment.created_at|naturaltime }}
                                        </span>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <span class="text-[10px] text-black">
                                            {{ comment.created_at|date:"M d, Y h:i A" }}
                                        </span>

                                        {% if request.user == comment.user or request.user.is_superuser %}
                                        <div class="relative">
                                            <button
                                                onclick="event.stopPropagation(); toggleCommentMenu(this.dataset.id)"
                                                data-id="{{ comment.id }}"
                                                class="text-gray-500 hover:text-black transition-colors focus:outline-none">
                                                <i class="fas fa-ellipsis-v"></i>
                                            </button>
                                            <div id="commentMenu-{{ comment.id }}"
                                                class="absolute right-0 top-full mt-1 w-24 bg-white border border-black/20 rounded-lg shadow-2xl hidden z-[100] flex flex-col overflow-hidden">
                                                <button onclick="showEditForm(this.getAttribute('data-id'))"
                                                    data-id="{{ comment.id }}"
                                                    class="text-xs text-left px-3 py-2 text-gray-700 hover:bg-black/10 hover:text-[#2ecc71] transition-colors border-b border-black/5 w-full">Edit</button>
                                                <button type="button"
                                                    onclick="showDeleteModal(this.getAttribute('data-id'), this)"
                                                    data-id="{{ comment.id }}"
                                                    class="text-xs text-left px-3 py-2 text-red-500 hover:bg-red-500/10 w-full transition-colors">Delete</button>
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <p id="comment-text-{{ comment.id }}" class="text-black text-sm leading-relaxed">
                                    {{ comment.content }}
                                </p>

                                <!-- Edit Form -->
                                <form id="edit-form-{{ comment.id }}" action="{% url 'edit_comment' comment.id %}"
                                    method="POST" class="hidden mt-3">
                                    {% csrf_token %}
                                    <div class="flex flex-col gap-2">
                                        <textarea name="content" rows="2"
                                            class="w-full bg-black/5 border border-[#2ecc71]/50 focus:border-[#2ecc71] rounded-lg p-2 text-sm text-black resize-none outline-none transition-colors">{{ comment.content }}</textarea>
                                        <div class="flex justify-end gap-2">
                                            <button type="button" onclick="hideEditForm(this.getAttribute('data-id'))"
                                                data-id="{{ comment.id }}"
                                                class="px-3 py-1 text-xs text-gray-600 hover:text-black transition-colors bg-black/5 rounded">Cancel</button>
                                            <button type="submit"
                                                class="px-3 py-1 bg-[#2ecc71] text-black text-xs font-bold hover:bg-[#27ae60] rounded transition-colors">Save</button>
                                        </div>
                                    </div>
                                </form>

                                <!-- Comment Engagement Icons Grouped -->
                                <div class="flex items-center mt-3">
                                    <div
                                        class="flex items-center bg-black/5 rounded-full border border-black/10 overflow-hidden">
                                        <form action="{% url 'toggle_comment_reaction' comment.id %}" method="POST"
                                            class="m-0 comment-reaction-form">
                                            {% csrf_token %}
                                            <input type="hidden" name="reaction" value="like">
                                            <button type="submit"
                                                class="pl-3 pr-2 py-1.5 hover:bg-[#00a8ff]/20 text-black hover:text-black flex items-center gap-1.5 transition-all group">
                                                <i class="fas fa-thumbs-up text-[10px] text-[#003B8E]"></i>
                                                <!-- prettier-ignore -->
                                                <span class="text-[10px] font-bold text-black">
                                                    {{ comment.like_count }}
                                                </span>
                                            </button>
                                        </form>
                                        <div class="w-[1px] h-3 bg-black/20"></div>
                                        <form action="{% url 'toggle_comment_reaction' comment.id %}" method="POST"
                                            class="m-0 comment-reaction-form">
                                            {% csrf_token %}
                                            <input type="hidden" name="reaction" value="dislike">
                                            <button type="submit"
                                                class="pl-2 pr-3 py-1.5 hover:bg-[#00a8ff]/20 text-black hover:text-black flex items-center gap-1.5 transition-all group">
                                                <i class="fas fa-thumbs-down text-[10px] text-[#ff4242]"></i>
                                                <!-- prettier-ignore -->
                                                <span class="text-[10px] font-bold text-black">
                                                    {{ comment.dislike_count }}
                                                </span>
                                            </button>
                                        </form>
                                    </div>
                                    <button onclick="toggleReplyForm(this.getAttribute('data-id'))"
                                        data-id="{{ comment.id }}"
                                        class="flex items-center gap-1.5 text-xs text-black/60 hover:text-[#2ecc71] transition-colors group ml-4 outline-none">
                                        <i class="fas fa-reply"></i>
                                        <span>Reply</span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Reply Form (Hidden) -->
                        <form id="reply-form-{{ comment.id }}" action="{% url 'add_comment' post.id %}" method="POST"
                            class="hidden ml-12 mb-4">
                            {% csrf_token %}
                            <input type="hidden" name="parent_id" value="{{ comment.id }}">
                            <div
                                class="flex items-center gap-3 bg-black/5 p-2 px-4 rounded-full border border-black/10 focus-within:border-[#00a8ff] transition-all">
                                <textarea name="content" rows="1"
                                    oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px';"
                                    class="w-full bg-transparent text-black border-none focus:ring-0 focus:outline-none p-1 text-xs resize-none placeholder-black/40 overflow-hidden min-h-0"
                                    placeholder="Write a reply..."></textarea>
                                <button type="submit"
                                    class="text-black hover:text-[#00a8ff] transition-all hover:scale-110 flex items-center justify-center">
                                    <svg viewBox="0 0 24 24" class="w-5 h-5 transform rotate-[45deg]" fill="none"
                                        stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <path d="M22 2L11 13M22 2L15 22L11 13L2 9L22 2z"></path>
                                    </svg>
                                </button>
                            </div>
                        </form>

                        <!-- Replies List -->
                        <div class="ml-12 space-y-2">
                            {% for reply in comment.replies.all|dictsort:"created_at" %}
                            <div
                                class="bg-black/5 p-2 rounded-xl border border-black/5 flex gap-3 hover:bg-black/10 transition-colors">
                                {% with r_pic=reply.user.profile.profile_picture.name %}
                                {% if r_pic and "default" not in r_pic %}
                                <img src="{{ reply.user.profile.profile_picture.url }}" alt="{{ reply.user.username }}"
                                    class="w-8 h-8 rounded-full object-cover flex-shrink-0 border border-white/10">
                                {% else %}
                                <div
                                    class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-purple-500 flex items-center justify-center flex-shrink-0 text-black font-bold text-sm">
                                    {{ reply.user.username|make_list|first|upper }}
                                </div>
                                {% endif %}
                                {% endwith %}
                                <div class="flex-1">
                                    <div class="flex items-baseline justify-between">
                                        <div class="flex items-baseline gap-2">
                                            <h5 class="font-bold text-xs">{{ reply.user.username }}</h5>
                                            <span class="text-[10px] opacity-60">
                                                {{ reply.created_at|naturaltime }}
                                            </span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span class="text-[9px] text-black">
                                                {{ reply.created_at|date:"M d, Y h:i A" }}
                                            </span>

                                            {% if request.user == reply.user or request.user.is_superuser %}
                                            <div class="relative">
                                                <button
                                                    onclick="event.stopPropagation(); toggleCommentMenu(this.dataset.id)"
                                                    data-id="{{ reply.id }}"
                                                    class="text-gray-500 hover:text-black transition-colors focus:outline-none text-[10px]">
                                                    <i class="fas fa-ellipsis-v"></i>
                                                </button>
                                                <div id="commentMenu-{{ reply.id }}"
                                                    class="absolute right-0 top-full mt-1 w-24 bg-white border border-black/20 rounded-lg shadow-2xl hidden z-[100] flex flex-col overflow-hidden">
                                                    <button onclick="showEditForm(this.getAttribute('data-id'))"
                                                        data-id="{{ reply.id }}"
                                                        class="text-[10px] text-left px-3 py-2 text-gray-700 hover:bg-black/10 hover:text-[#2ecc71] transition-colors border-b border-black/5 w-full">Edit</button>
                                                    <button type="button"
                                                        onclick="showDeleteModal(this.getAttribute('data-id'), this)"
                                                        data-id="{{ reply.id }}"
                                                        class="text-[10px] text-left px-3 py-2 text-red-500 hover:bg-red-500/10 w-full transition-colors">Delete</button>
                                                </div>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <p id="comment-text-{{ reply.id }}"
                                        class="text-black text-xs leading-relaxed mt-0.5">{{ reply.content }}</p>

                                    <!-- Edit Form for Reply -->
                                    <form id="edit-form-{{ reply.id }}" action="{% url 'edit_comment' reply.id %}"
                                        method="POST" class="hidden mt-2">
                                        {% csrf_token %}
                                        <div class="flex flex-col gap-2">
                                            <textarea name="content" rows="1"
                                                class="w-full bg-black/30 border border-[#2ecc71]/50 focus:border-[#2ecc71] rounded-lg p-2 text-xs text-black resize-none outline-none transition-colors">{{ reply.content }}</textarea>
                                            <div class="flex justify-end gap-2">
                                                <button type="button"
                                                    onclick="hideEditForm(this.getAttribute('data-id'))"
                                                    data-id="{{ reply.id }}"
                                                    class="px-2 py-0.5 text-[10px] text-gray-400 hover:text-white transition-colors bg-white/5 rounded">Cancel</button>
                                                <button type="submit"
                                                    class="px-2 py-0.5 bg-[#2ecc71] text-black text-[10px] font-bold hover:bg-[#27ae60] rounded transition-colors">Save</button>
                                            </div>
                                        </div>
                                    </form>

                                    <!-- Reply Engagement Grouped -->
                                    <div
                                        class="flex items-center bg-black/5 rounded-full border border-black/5 overflow-hidden mt-1.5 w-max opacity-80 hover:opacity-100 transition-opacity">
                                        <form action="{% url 'toggle_comment_reaction' reply.id %}" method="POST"
                                            class="m-0 comment-reaction-form">
                                            {% csrf_token %}
                                            <input type="hidden" name="reaction" value="like">
                                            <button type="submit"
                                                class="pl-2 pr-1.5 py-1 hover:bg-[#00a8ff]/20 text-black hover:text-black flex items-center gap-1 transition-all">
                                                <i class="fas fa-thumbs-up text-[8px] text-[#003B8E]"></i>
                                                <!-- prettier-ignore -->
                                                <span class="text-[10px] font-bold text-black">
                                                    {{ reply.like_count }}
                                                </span>
                                            </button>
                                        </form>
                                        <div class="w-[1px] h-2.5 bg-black/10"></div>
                                        <form action="{% url 'toggle_comment_reaction' reply.id %}" method="POST"
                                            class="m-0 comment-reaction-form">
                                            {% csrf_token %}
                                            <input type="hidden" name="reaction" value="dislike">
                                            <button type="submit"
                                                class="pl-1.5 pr-2 py-1 hover:bg-[#00a8ff]/20 text-black hover:text-black flex items-center gap-1 transition-all">
                                                <i class="fas fa-thumbs-down text-[8px] text-[#ff4242]"></i>
                                                <!-- prettier-ignore -->
                                                <span class="text-[10px] font-bold text-black">
                                                    {{ reply.dislike_count }}
                                                </span>
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    {% empty %}
                    <div class="text-center py-6 text-gray-500 italic text-sm">
                        No comments yet. Be the first to share your thoughts!
                    </div>
                    {% endfor %}
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Custom Delete Confirmation Modal -->
<div id="deleteModal" class="fixed inset-0 z-[300] hidden items-center justify-center bg-[#0a0a0f]/80 backdrop-blur-sm">
    <div
        class="bg-white border border-black/10 p-6 rounded-2xl shadow-2xl max-w-sm w-full mx-4 transform transition-all">
        <div class="text-center">
            <div
                class="w-16 h-16 bg-red-500/10 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-trash-alt text-2xl"></i>
            </div>
            <h3 class="text-xl font-bold text-black mb-2">Delete Comment?</h3>
            <p class="text-gray-600 text-sm mb-6">Are you sure you want to delete this? This action cannot be undone.
            </p>
            <div class="flex gap-3">
                <button id="cancelDelete"
                    class="flex-1 px-4 py-2 bg-black/5 text-black rounded-lg hover:bg-black/10 transition-colors">No,
                    Cancel</button>
                <button id="confirmDelete"
                    class="flex-1 px-4 py-2 bg-red-600 text-black rounded-lg hover:bg-red-700 transition-colors font-bold">Yes,
                    Delete</button>
            </div>
        </div>
    </div>
</div>

<style>
    /* Content Renderer Refinements */
    .content-renderer p {
        margin-bottom: 1.5rem;
        font-size: 1rem;
    }

    .content-renderer h2,
    .content-renderer h3 {
        color: black;
        margin-top: 2.5rem;
        margin-bottom: 1rem;
    }

    .content-renderer blockquote {
        border-left: 3px solid #2ecc71;
        background: rgba(46, 204, 113, 0.05);
        padding: 1rem;
        border-radius: 0 0.5rem 0.5rem 0;
        margin: 1.5rem 0;
        font-style: italic;
    }

    .glass-card {
        background: rgba(0, 0, 0, 0.03);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid rgba(0, 0, 0, 0.08);
    }
</style>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        document.getElementById('shareUrlInput').value = window.location.href;
    });

    function toggleShareMenu(e) {
        if (e) e.stopPropagation();
        const menu = document.getElementById('shareMenu');
        menu.classList.toggle('hidden');
    }

    function copyShareLink() {
        const urlInput = document.getElementById('shareUrlInput');
        urlInput.select();
        urlInput.setSelectionRange(0, 99999);
        navigator.clipboard.writeText(urlInput.value);

        const msg = document.getElementById('copySuccessMsg');
        msg.classList.remove('opacity-0');

        setTimeout(() => {
            msg.classList.add('opacity-0');
            setTimeout(() => {
                const shareMenu = document.getElementById('shareMenu');
                if (shareMenu) shareMenu.classList.add('hidden');
            }, 300);
        }, 1500);
    }

    function shareTo(platform) {
        let url = encodeURIComponent(window.location.href);
        let title = encodeURIComponent(document.title);
        let shareUrl = "";

        if (platform === 'facebook') {
            shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${url}`;
        } else if (platform === 'twitter') {
            shareUrl = `https://twitter.com/intent/tweet?url=${url}&text=${title}`;
        } else if (platform === 'linkedin') {
            shareUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${url}`;
        } else if (platform === 'whatsapp') {
            shareUrl = `https://api.whatsapp.com/send?text=${title} - ${url}`;
        }

        if (shareUrl) {
            window.open(shareUrl, '_blank', 'width=600,height=400');
            document.getElementById('shareMenu').classList.add('hidden');
        }
    }

    // Modal Control for Deletion
    let commentIdToDelete = null;
    let commentElementToDelete = null;

    function showDeleteModal(id, btn) {
        commentIdToDelete = id;
        commentElementToDelete = btn.closest('.space-y-3') || btn.closest('.bg-white\\/5.p-2.rounded-xl');
        document.getElementById('deleteModal').classList.remove('hidden');
        document.getElementById('deleteModal').classList.add('flex');
        // Hide the dropdown menu
        const menu = document.getElementById(`commentMenu-${id}`);
        if (menu) menu.classList.add('hidden');
    }

    function hideDeleteModal() {
        document.getElementById('deleteModal').classList.add('hidden');
        document.getElementById('deleteModal').classList.remove('flex');
        commentIdToDelete = null;
        commentElementToDelete = null;
    }

    document.getElementById('cancelDelete')?.addEventListener('click', hideDeleteModal);

    document.getElementById('confirmDelete')?.addEventListener('click', async function () {
        if (!commentIdToDelete) return;

        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        try {
            const response = await fetch(`/core/comment/${commentIdToDelete}/delete/`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            });
            const data = await response.json();
            if (data.status === 'success') {
                if (commentElementToDelete) {
                    // Smoothly collapse the element
                    commentElementToDelete.style.maxHeight = commentElementToDelete.offsetHeight + 'px';
                    commentElementToDelete.style.overflow = 'hidden';
                    commentElementToDelete.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
                    commentElementToDelete.style.opacity = '1';

                    // Force a reflow
                    commentElementToDelete.offsetHeight;

                    commentElementToDelete.style.opacity = '0';
                    commentElementToDelete.style.maxHeight = '0';
                    commentElementToDelete.style.marginTop = '0';
                    commentElementToDelete.style.marginBottom = '0';
                    commentElementToDelete.style.paddingTop = '0';
                    commentElementToDelete.style.paddingBottom = '0';
                    commentElementToDelete.style.pointerEvents = 'none';

                    setTimeout(() => {
                        commentElementToDelete.remove();
                        loadComments(); // Ensure server state is synced
                    }, 400);
                } else {
                    loadComments();
                }
                updateCommentCounts(data.total_comments);
                showToast('Comment deleted successfully', 'success');
            }
        } catch (error) {
            console.error('Delete Error:', error);
            showToast('Failed to delete comment', 'error');
        } finally {
            hideDeleteModal();
        }
    });

    function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        const bgColor = type === 'success' ? 'bg-[#2ecc71]' : 'bg-red-500';
        toast.className = `fixed bottom-5 right-5 ${bgColor} text-white px-6 py-3 rounded-xl shadow-2xl z-[400] transition-all transform duration-300 translate-y-20 opacity-0`;
        toast.innerHTML = `<div class="flex items-center gap-2"><i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i> ${message}</div>`;
        document.body.appendChild(toast);

        // Trigger animation
        setTimeout(() => {
            toast.classList.remove('translate-y-20', 'opacity-0');
        }, 10);

        setTimeout(() => {
            toast.classList.add('translate-y-20', 'opacity-0');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    function updateCommentCounts(count) {
        const countLabels = [document.getElementById('header-comment-count'), ...document.querySelectorAll('a[href="#comments"] span')];
        countLabels.forEach(el => {
            if (el) el.textContent = count;
        });
    }

    // Close menus if clicking outside
    document.addEventListener('click', function (event) {
        const menu = document.getElementById('shareMenu');
        if (menu) {
            const shareBtn = menu.parentElement.querySelector('button');
            if (!menu.contains(event.target) && !shareBtn.contains(event.target) && !menu.classList.contains('hidden')) {
                menu.classList.add('hidden');
            }
        }

        // Close comment menus
        const commentMenus = document.querySelectorAll('[id^="commentMenu-"]');
        commentMenus.forEach(cMenu => {
            const btn = cMenu.previousElementSibling;
            if (btn && !cMenu.contains(event.target) && !btn.contains(event.target) && !cMenu.classList.contains('hidden')) {
                cMenu.classList.add('hidden');
            }
        });

        // Close delete modal on click outside content
        const deleteModal = document.getElementById('deleteModal');
        if (event.target === deleteModal) hideDeleteModal();
    });

    function toggleCommentMenu(id) {
        const menu = document.getElementById(`commentMenu-${id}`);
        if (!menu) return;

        if (menu.classList.contains('hidden')) {
            document.querySelectorAll('[id^="commentMenu-"]').forEach(m => m.classList.add('hidden'));
            menu.classList.remove('hidden');
        } else {
            menu.classList.add('hidden');
        }
    }

    function showEditForm(id) {
        document.getElementById(`comment-text-${id}`).classList.add('hidden');
        document.getElementById(`edit-form-${id}`).classList.remove('hidden');
        document.getElementById(`commentMenu-${id}`).classList.add('hidden');
    }

    function hideEditForm(id) {
        document.getElementById(`comment-text-${id}`).classList.remove('hidden');
        document.getElementById(`edit-form-${id}`).classList.add('hidden');
    }

    function toggleReplyForm(id) {
        const form = document.getElementById(`reply-form-${id}`);
        if (!form) return;
        if (form.classList.contains('hidden')) {
            form.classList.remove('hidden');
            form.querySelector('textarea').focus();
        } else {
            form.classList.add('hidden');
        }
    }

    // AJAX Handling
    async function handleAjaxForm(form, onSuccess) {
        const formData = new FormData(form);
        try {
            const response = await fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            });
            const data = await response.json();
            if (data.status === 'success') {
                onSuccess(data);
            }
        } catch (error) {
            console.error('AJAX Error:', error);
        }
    }

    // Post Reactions AJAX
    document.querySelectorAll('.post-reaction-form').forEach(form => {
        form.addEventListener('submit', function (e) {
            e.preventDefault();
            handleAjaxForm(this, (data) => {
                const likeCount = document.getElementById('post-like-count');
                const dislikeCount = document.getElementById('post-dislike-count');
                if (likeCount) likeCount.textContent = data.likes;
                if (dislikeCount) dislikeCount.textContent = data.dislikes;
            });
        });
    });

    // Delegated Handlers for Comments/Replies
    document.addEventListener('submit', function (e) {
        const form = e.target;

        // Comment/Reply Reactions
        if (form.classList.contains('comment-reaction-form')) {
            e.preventDefault();
            handleAjaxForm(form, (data) => {
                const container = form.closest('.flex.items-center.bg-white\\/5');
                if (container) {
                    const spans = container.querySelectorAll('span');
                    if (spans.length >= 2) {
                        spans[0].textContent = data.likes;
                        spans[1].textContent = data.dislikes;
                    }
                }
            });
        }

        // Edit Comment Form
        if (form.id && form.id.startsWith('edit-form-')) {
            e.preventDefault();
            const id = form.id.replace('edit-form-', '');
            handleAjaxForm(form, (data) => {
                const textEl = document.getElementById(`comment-text-${id}`);
                if (textEl) {
                    textEl.textContent = data.content;
                    hideEditForm(id);
                    showToast('Comment updated');
                }
            });
        }

        // Main Comment or Reply Form
        if (form.id === 'main-comment-form' || (form.id && form.id.startsWith('reply-form-'))) {
            e.preventDefault();
            const isReply = form.id.startsWith('reply-form-');
            const textarea = form.querySelector('textarea');

            handleAjaxForm(form, (data) => {
                textarea.value = '';
                textarea.style.height = 'auto';
                if (isReply) form.classList.add('hidden');

                updateCommentCounts(data.total_comments);
                showToast(isReply ? 'Reply posted' : 'Comment posted');

                // Immediately append the new comment/reply (simple list refresh for now to ensure all logic/icons work)
                // For a truly perfect UX, we'd inject the HTML, but a silent redirect or reloading the comments container via fetch is safer for complex structures.
                // Let's do a quick reload of the comments container to reflect changes immediately
                loadComments();
            });
        }
    });

    async function loadComments() {
        try {
            const response = await fetch(window.location.href);
            const html = await response.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const newComments = doc.querySelector('#comments .space-y-4');
            const oldComments = document.querySelector('#comments .space-y-4');
            if (newComments && oldComments) {
                oldComments.innerHTML = newComments.innerHTML;
            }
        } catch (error) {
            console.error('Error reloading comments:', error);
        }
    }
</script>
{% endblock %}